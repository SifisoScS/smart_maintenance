@page "/requests/create"
@using frontend.Models
@using frontend.Services.Interfaces
@inject IApiService ApiService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IToastService ToastService

<PageTitle>Create Request - Smart Maintenance</PageTitle>

<div class="create-request-container">
    <div class="create-request-card">
        <div class="page-header">
            <button class="btn btn-secondary btn-sm" @onclick="@(() => Navigation.NavigateTo("/requests"))">
                ← Back to Requests
            </button>
            <h2>Create Maintenance Request</h2>
            <p class="subtitle">Submit a new request for maintenance or repair</p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                <strong>⚠️ Error:</strong> @errorMessage
            </div>
        }

        <EditForm Model="@createRequest" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <!-- Title -->
            <div class="form-group">
                <label for="title">Title <span class="required">*</span></label>
                <InputText id="title"
                          @bind-Value="createRequest.Title"
                          class="form-control"
                          placeholder="Brief description of the issue"
                          disabled="@isSubmitting" />
                <ValidationMessage For="@(() => createRequest.Title)" class="text-danger" />
            </div>

            <!-- Description -->
            <div class="form-group">
                <label for="description">Description <span class="required">*</span></label>
                <InputTextArea id="description"
                              @bind-Value="createRequest.Description"
                              class="form-control"
                              rows="4"
                              placeholder="Provide detailed information about the issue..."
                              disabled="@isSubmitting" />
                <ValidationMessage For="@(() => createRequest.Description)" class="text-danger" />
            </div>

            <!-- Request Type -->
            <div class="form-group">
                <label for="requestType">Request Type <span class="required">*</span></label>
                <InputSelect id="requestType"
                            @bind-Value="createRequest.RequestType"
                            class="form-control"
                            disabled="@isSubmitting">
                    <option value="">-- Select a type --</option>
                    <option value="repair">Repair</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="inspection">Inspection</option>
                    <option value="installation">Installation</option>
                </InputSelect>
                <ValidationMessage For="@(() => createRequest.RequestType)" class="text-danger" />
            </div>

            <!-- Category -->
            <div class="form-group">
                <label for="category">Category <span class="required">*</span></label>
                <InputSelect id="category"
                            @bind-Value="category"
                            class="form-control"
                            disabled="@isSubmitting">
                    <option value="">-- Select a category --</option>
                    <option value="electrical">Electrical</option>
                    <option value="plumbing">Plumbing</option>
                    <option value="hvac">HVAC</option>
                </InputSelect>
                <small class="form-text text-muted">Select the technical category for this maintenance request</small>
            </div>

            <!-- Priority -->
            <div class="form-group">
                <label for="priority">Priority <span class="required">*</span></label>
                <InputSelect id="priority"
                            @bind-Value="createRequest.Priority"
                            class="form-control"
                            disabled="@isSubmitting">
                    <option value="">-- Select priority --</option>
                    <option value="low">Low - Can wait</option>
                    <option value="medium">Medium - Normal timeline</option>
                    <option value="high">High - Urgent attention needed</option>
                </InputSelect>
                <ValidationMessage For="@(() => createRequest.Priority)" class="text-danger" />
                <small class="form-text">
                    Select priority based on urgency and impact
                </small>
            </div>

            <!-- Asset Selection -->
            <div class="form-group">
                <label for="asset">Related Asset (Optional)</label>
                @if (isLoadingAssets)
                {
                    <div class="loading-text">Loading assets...</div>
                }
                else if (assets != null && assets.Any())
                {
                    <InputSelect id="asset"
                                @bind-Value="selectedAssetId"
                                class="form-control"
                                disabled="@isSubmitting">
                        <option value="0">-- No specific asset --</option>
                        @foreach (var asset in assets)
                        {
                            <option value="@asset.Id">@asset.Name (@asset.AssetCode) - @asset.Location</option>
                        }
                    </InputSelect>
                    <small class="form-text">
                        If this request relates to a specific asset, select it here
                    </small>
                }
                else
                {
                    <input id="asset" type="text" class="form-control" value="No assets available" disabled />
                }
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" @onclick="Cancel" disabled="@isSubmitting">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span> Submitting...</span>
                    }
                    else
                    {
                        <span>Submit Request</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>
</div>

<style>
    .create-request-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .create-request-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 40px;
    }

    .page-header {
        margin-bottom: 32px;
    }

    .page-header h2 {
        color: #1f2937;
        margin: 16px 0 8px 0;
        font-size: 28px;
        font-weight: 700;
    }

    .subtitle {
        color: #6b7280;
        font-size: 16px;
        margin: 0;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #374151;
        font-weight: 600;
        font-size: 14px;
    }

    .required {
        color: #dc2626;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
        box-sizing: border-box;
        font-family: inherit;
    }

    .form-control:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-control:disabled {
        background-color: #f9fafb;
        cursor: not-allowed;
    }

    .form-text {
        display: block;
        margin-top: 6px;
        color: #6b7280;
        font-size: 13px;
    }

    .loading-text {
        padding: 12px 16px;
        background-color: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        color: #6b7280;
        font-size: 14px;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
    }

    .btn-primary {
        background-color: #4f46e5;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: #4338ca;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
    }

    .btn-secondary {
        background-color: #6b7280;
        color: white;
    }

    .btn-secondary:hover:not(:disabled) {
        background-color: #4b5563;
    }

    .btn:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 24px;
        font-size: 14px;
    }

    .alert-danger {
        background-color: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .text-danger {
        color: #dc2626;
        font-size: 12px;
        margin-top: 4px;
        display: block;
    }

    .spinner-border {
        width: 1rem;
        height: 1rem;
        border: 2px solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spinner-border 0.75s linear infinite;
        margin-right: 8px;
    }

    .spinner-border-sm {
        width: 0.875rem;
        height: 0.875rem;
        border-width: 0.2em;
    }

    @@keyframes spinner-border {
        to {
            transform: rotate(360deg);
        }
    }

    /* Responsive design */
    @@media (max-width: 768px) {
        .create-request-container {
            padding: 10px;
        }

        .create-request-card {
            padding: 24px 20px;
        }

        .page-header h2 {
            font-size: 24px;
        }

        .form-actions {
            flex-direction: column-reverse;
        }

        .form-actions .btn {
            width: 100%;
        }
    }
</style>

@code {
    private CreateRequestDto createRequest = new();
    private List<AssetModel>? assets;
    private UserModel? currentUser;
    private string selectedAssetId = "0";
    private string category = string.Empty;

    private bool isSubmitting = false;
    private bool isLoadingAssets = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
    }

    private async Task LoadInitialData()
    {
        try
        {
            currentUser = await AuthService.GetCurrentUserAsync();

            if (currentUser == null)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            // Load assets for selection
            isLoadingAssets = true;
            try
            {
                assets = await ApiService.GetAssetsAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading assets: {ex.Message}");
                // Don't block the form if assets can't be loaded
                assets = new List<AssetModel>();
            }
            finally
            {
                isLoadingAssets = false;
            }

            // Set default priority
            createRequest.Priority = "medium";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
            Console.WriteLine($"LoadInitialData error: {ex.Message}");
        }
    }

    private async Task HandleSubmit()
    {
        errorMessage = string.Empty;

        // Validate required fields
        if (string.IsNullOrWhiteSpace(createRequest.Title))
        {
            errorMessage = "Title is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(createRequest.Description))
        {
            errorMessage = "Description is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(createRequest.RequestType))
        {
            errorMessage = "Request Type is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(category))
        {
            errorMessage = "Category is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(createRequest.Priority))
        {
            errorMessage = "Priority is required";
            return;
        }

        try
        {
            isSubmitting = true;

            // Set asset ID if selected
            if (int.TryParse(selectedAssetId, out int assetId) && assetId > 0)
            {
                createRequest.AssetId = assetId;
            }

            // Backend uses Category as request_type for Factory pattern
            // Only send request_type (technical category), not category field
            var backendRequest = new CreateRequestDto
            {
                RequestType = category, // Backend expects technical category here
                Title = createRequest.Title,
                Description = createRequest.Description,
                Priority = createRequest.Priority,
                AssetId = createRequest.AssetId
            };

            // Submit request
            var response = await ApiService.CreateRequestAsync(backendRequest);

            if (response.Success)
            {
                ToastService.ShowSuccess("Maintenance request submitted successfully!");
                // Navigate to requests list since we don't have the new request ID from ApiResponse
                Navigation.NavigateTo("/requests");
            }
            else
            {
                errorMessage = response.Message ?? "Failed to create request. Please try again.";
                ToastService.ShowError(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error submitting request: {ex.Message}";
            ToastService.ShowError(errorMessage);
            Console.WriteLine($"HandleSubmit error: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/requests");
    }
}
